# ZONIX Backend Rules for Cursor AI

## ðŸ­ Business Model Context

### ðŸŽ¯ **Core Business: Gas Distribution Management System**
ZONIX es un sistema integral de gestiÃ³n de distribuciÃ³n de gas domÃ©stico que maneja:

#### **ðŸª Estaciones de Gas (Stations)**
- **Ubicaciones fÃ­sicas** donde se distribuye gas
- **Horarios especÃ­ficos** por dÃ­a de la semana
- **LÃ­mite diario**: 200 citas por estaciÃ³n
- **CÃ³digos Ãºnicos** para identificaciÃ³n
- **Estado activo/inactivo**

#### **ðŸŽ« Tickets de Gas (Gas Tickets)**
- **Sistema de citas** para compra de bombonas
- **Cola virtual** con posiciones (1-200)
- **Estados del ticket**:
  - `pending` - Pendiente de verificaciÃ³n
  - `verifying` - En proceso de verificaciÃ³n
  - `waiting` - Esperando en cola
  - `dispatched` - Entregado/Comprado
  - `canceled` - Cancelado
  - `expired` - Expirado
- **Reglas de negocio**:
  - **21 dÃ­as mÃ­nimo** entre compras (para usuarios internos)
  - **Citas solo en domingo** para usuarios externos
  - **ExpiraciÃ³n**: 2 dÃ­as despuÃ©s de la cita
  - **QR Code** Ãºnico por ticket

#### **ðŸ›¢ï¸ Bombonas de Gas (Gas Cylinders)**
- **Tipos**: small, wide
- **Pesos**: 10kg, 18kg, 45kg
- **CÃ³digos Ãºnicos** de fabricaciÃ³n
- **AprobaciÃ³n** requerida antes de uso
- **Proveedores** asociados

#### **ðŸ‘¥ Roles de Usuario**
1. **Usuario Regular**: Crear tickets, ver historial
2. **Sales Admin**: Verificar datos, escanear QR, aprobar tickets
3. **Dispatcher**: Gestionar colas, despachar tickets

### ðŸ”„ **Flujo de Negocio Principal**
1. **Usuario crea ticket** â†’ Selecciona bombona â†’ Asigna estaciÃ³n
2. **Sistema valida** â†’ Reglas de negocio â†’ Asigna posiciÃ³n en cola
3. **Sales Admin verifica** â†’ Escanea QR â†’ Valida datos
4. **Dispatcher gestiona** â†’ Cola fÃ­sica â†’ Entrega bombona
5. **Ticket marcado** â†’ `dispatched` â†’ Registro completo

## Project Context
- This is the **Backend** (Laravel) part of the ZONIX project
- **Backend**: Laravel 10 (PHP 8.1+) - REST API
- **Frontend**: Flutter 3.35.2 (Dart 3.9.0) - Mobile app (see `zonix` directory)
- **Database**: MySQL with complex relationships (users, profiles, tickets, stations)
- **Authentication**: Laravel Sanctum for API authentication
- **Project**: ZONIX is a gas distribution management system
- Handles Google Sign-In, profiles, tickets, and role-based access

## File Structure
- **Backend (this project)**: `/var/www/html/proyectos/AIPP/PRODUCCION/ZONIX/zonix-backend/`
- **Frontend (separate repo)**: `/var/www/html/proyectos/AIPP/PRODUCCION/ZONIX/zonix/`
- **Key backend files**: 
  - Controllers: `app/Http/Controllers/`
  - Models: `app/Models/`
  - Routes: `routes/api.php`
  - Migrations: `database/migrations/`
  - Seeders: `database/seeders/`
- **Key frontend files**: `lib/main.dart`, `lib/features/`

## Coding Standards

### PHP/Laravel
- Use Spanish comments and variable names when possible
- Follow Laravel conventions: snake_case for database, camelCase for variables
- Use Eloquent relationships properly
- Always validate input data with Form Requests
- Use proper HTTP status codes
- Handle errors with try-catch and logging
- Use Laravel Sanctum for authentication
- Follow PSR-12 coding standards

### API Design
- Use RESTful conventions
- Always return JSON responses with consistent structure
- Include proper HTTP headers
- Use Bearer token authentication
- Handle CORS properly
- Validate all inputs
- Use proper HTTP methods (GET, POST, PUT, DELETE)

## Database Rules

### Models and Relationships
- User 1:1 Profile
- Profile has many: Phones, Emails, Documents, Addresses
- GasTicket belongs to: Profile, GasCylinder, Station
- Use proper foreign keys and constraints
- Always define relationships in models
- Use $casts for data type conversion
- Use $fillable/$guarded properly

### Business Logic Rules
- **Ticket Creation Validation**:
  - Check 21-day rule for internal users
  - Validate Sunday-only for external users
  - Verify daily limit (200 tickets per station)
  - Assign automatic queue position
  - Generate unique QR code
- **Ticket State Management**:
  - `pending` â†’ `verifying` (Sales Admin only)
  - `verifying` â†’ `waiting` (Sales Admin only)
  - `waiting` â†’ `dispatched` (Dispatcher only)
  - Auto-expire after 2 days
- **Station Validation**:
  - Check days available per station
  - Validate opening/closing times
  - Handle external vs internal appointments
- **Gas Cylinder Rules**:
  - Must be approved before use
  - Validate manufacturing date
  - Check supplier association

### Example Model Structure
```php
class GasTicket extends Model
{
    protected $fillable = [
        'profile_id', 'gas_cylinders_id', 'status', 'queue_position'
    ];
    
    protected $casts = [
        'id' => 'integer',
        'profile_id' => 'integer',
        'gas_cylinders_id' => 'integer',
        'queue_position' => 'integer',
        'created_at' => 'datetime',
        'updated_at' => 'datetime'
    ];
    
    public function profile()
    {
        return $this->belongsTo(Profile::class);
    }
    
    public function gasCylinder()
    {
        return $this->belongsTo(GasCylinder::class);
    }
}
```

## Authentication Rules

### Sanctum Implementation
- Use Laravel Sanctum for API authentication
- Store tokens securely
- Handle token expiration
- Validate user permissions
- Use middleware for protected routes

### Google Sign-In Flow
```php
// AuthController::googleUser()
public function googleUser(Request $request)
{
    try {
        // Validate Google token
        // Create or update user
        // Generate Sanctum token
        // Return user data with role
        
        return response()->json([
            'success' => true,
            'token' => $token,
            'user' => [
```

### Business Logic Implementation
```php
// GasTicketController::store() - Business Rules
class GasTicketController extends Controller
{
    public function store(Request $request)
    {
        // 1. Validate 21-day rule for internal users
        $lastTicket = GasTicket::where('profile_id', $request->profile_id)
            ->where('status', 'dispatched')
            ->orderBy('appointment_date', 'desc')
            ->first();
            
        if ($lastTicket && Carbon::now()->diffInDays($lastTicket->appointment_date) < 21) {
            return response()->json(['message' => 'Must wait 21 days between purchases'], 400);
        }
        
        // 2. Validate Sunday-only for external users
        if ($request->is_external && !Carbon::now()->isSunday()) {
            return response()->json(['message' => 'External appointments only on Sundays'], 400);
        }
        
        // 3. Check daily limit (200 tickets per station)
        $dailyCount = GasTicket::whereDate('appointment_date', $appointmentDate)
            ->where('station_id', $stationId)
            ->count();
            
        if ($dailyCount >= 200) {
            return response()->json(['message' => 'Daily limit reached'], 400);
        }
        
        // 4. Assign queue position
        $queuePosition = $dailyCount + 1;
        
        // 5. Generate QR code
        $qrCode = $gasCylinder->gas_cylinder_code;
    }
}
```
                'id' => $user->id,
                'role' => $user->role,
                'completed_onboarding' => $user->completed_onboarding
            ]
        ]);
    } catch (Exception $e) {
        Log::error('Google auth error: ' . $e->getMessage());
        return response()->json(['success' => false, 'message' => 'Authentication failed'], 401);
    }
}
```

## Error Handling

### Consistent Error Responses
```php
// Always use this structure
return response()->json([
    'success' => false,
    'message' => 'Error description',
    'errors' => $errors // if validation errors
], $statusCode);
```

### Logging
```php
// Always log errors with context
Log::error('Error in GasTicketController: ' . $e->getMessage(), [
    'user_id' => $request->user()->id,
    'action' => 'create_ticket',
    'data' => $request->all()
]);
```

## API Response Patterns

### Success Response
```php
return response()->json([
    'success' => true,
    'data' => $data,
    'message' => 'Operation completed successfully'
], 200);
```

### Validation Error
```php
return response()->json([
    'success' => false,
    'message' => 'Validation failed',
    'errors' => $validator->errors()
], 422);
```

### Not Found
```php
return response()->json([
    'success' => false,
    'message' => 'Resource not found'
], 404);
```

## Security Rules

### Input Validation
- Always validate all inputs
- Use Form Request classes for complex validation
- Sanitize user inputs
- Never trust user data
- Use proper validation rules

### Authentication
- Always check user permissions
- Use middleware for protected routes
- Validate tokens properly
- Handle expired tokens gracefully

### Data Protection
- Never expose sensitive data in responses
- Use proper encryption for sensitive data
- Log security events
- Implement rate limiting

## Database Operations

### Migrations
- Use descriptive migration names
- Include proper foreign key constraints
- Add indexes for performance
- Use proper data types
- Include rollback methods

### Seeders
- Create realistic test data
- Use factories when possible
- Include all required relationships
- Make seeders idempotent

## Testing Guidelines

### Unit Tests
- Test all model relationships
- Test validation rules
- Test authentication logic
- Test error handling

### Feature Tests
- Test all API endpoints
- Test authentication flows
- Test role-based access
- Test error scenarios

## Performance Rules

### Database Optimization
- Use proper indexing
- Avoid N+1 queries
- Use eager loading for relationships
- Implement caching where appropriate

### API Optimization
- Use pagination for large datasets
- Implement proper caching headers
- Optimize response size
- Use proper HTTP status codes

## Environment Configuration

### Local Development
- APP_ENV=local
- APP_DEBUG=true
- DB_DATABASE=zionix_BD
- APP_URL_LOCAL=http://192.168.27.4:8000
- Device: Always 192.168.27.5:5555

### Production
- APP_ENV=production
- APP_DEBUG=false
- Use proper environment variables
- Enable caching
- CI/CD: Automatic deployment on GitHub push

### Database Management
- Reset database when schema changes required
- Use seeders for different testing scenarios
- Backup before major changes

## Remember
- This is a production API handling real user data
- Security is critical - validate everything
- Follow Laravel best practices
- Use proper error handling
- Log important events
- Test thoroughly before commits
- Document API endpoints
- Use consistent response formats
- Handle authentication properly
- Optimize for performance
- Use Spanish for comments and user-facing content
- Reset database when schema changes required
- CI/CD deployment on GitHub push
- Always test in local before pushing

## Project Status and Analysis (Diciembre 2024)

### Estado Actual del Proyecto
- **Score de Mantenibilidad**: 7/10
- **Estado**: Production Ready con mejoras crÃ­ticas recomendadas
- **VersiÃ³n**: 1.0.0
- **Controladores**: 12 clases
- **Modelos**: 16 modelos Eloquent
- **Rutas API**: ~66 endpoints
- **Tests**: 11 archivos (6 Feature, 3 Unit, 2 base)

### Fortalezas Identificadas
- âœ… Arquitectura clara: MVC de Laravel bien estructurado
- âœ… Reglas de negocio: Implementadas y documentadas correctamente
- âœ… AutenticaciÃ³n robusta: Laravel Sanctum con roles
- âœ… Testing parcial: 11 archivos de tests implementados

### Vulnerabilidades CrÃ­ticas Identificadas
- âŒ **CRÃTICO: Rutas de debug expuestas** - `routes/api.php:19-27`
  - `/env-test` - Expone configuraciÃ³n (dd de variables de entorno)
  - `/migrate-refresh` - Permite resetear BD en producciÃ³n
  - **RemediaciÃ³n INMEDIATA**: Eliminar o proteger con middleware `env('APP_ENV') === 'local'` (5 minutos)

### Deuda TÃ©cnica Identificada
- âš ï¸ **LÃ³gica en controladores**: Algunos controladores con lÃ³gica de negocio compleja
  - **UbicaciÃ³n**: Varios controladores en `app/Http/Controllers/`
  - **RecomendaciÃ³n**: Extraer a servicios de negocio (1 semana)
- âš ï¸ **Falta caching**: Sin estrategias de caching implementadas
  - **RecomendaciÃ³n**: Implementar Redis/caching bÃ¡sico (2-4 horas)
- âš ï¸ **Posibles N+1 queries**: No verificadas exhaustivamente
  - **RecomendaciÃ³n**: Revisar y agregar eager loading (2-3 horas)

### Recomendaciones Prioritizadas
- **CRÃTICO (Inmediato - 1 dÃ­a)**:
  1. âŒ Eliminar rutas de debug (`/env-test`, `/migrate-refresh`) - 5 minutos
  2. âŒ Verificar headers de seguridad (CORS, CSP, HSTS) - 1 hora
- **Alta Prioridad (1 semana)**:
  3. âš ï¸ Implementar tests adicionales para endpoints crÃ­ticos - 1 semana
  4. âš ï¸ Agregar rate limiting en autenticaciÃ³n - 2-4 horas
- **Media Prioridad (2-4 semanas)**:
  5. â³ Extraer servicios de negocio de controladores - 1 semana
  6. â³ Implementar caching (Redis) - 2-4 horas
  7. â³ Revisar y optimizar queries (N+1, Ã­ndices) - 2-3 horas

### MÃ©tricas del Proyecto (Verificado Diciembre 2024)
- **VersiÃ³n**: 1.0.0
- **LÃ­neas de cÃ³digo (controladores)**: ~2,114 lÃ­neas PHP
- **Controladores**: 12 clases (1 importado pero sin rutas: NeighborhoodAssociationController)
- **Modelos**: 16 modelos Eloquent
- **Rutas API**: 66 endpoints registrados (segÃºn `php artisan route:list`)
  - 2 rutas debug crÃ­ticas expuestas: `/env-test`, `/migrate-refresh`
  - 58+ endpoints funcionales autenticados
- **Migraciones**: 22 archivos de migraciÃ³n
- **Tests**: 11 archivos PHP
  - Feature: 6 archivos (35+ mÃ©todos test identificados)
  - Unit: 3 archivos (17+ mÃ©todos test identificados)
  - Base: 2 archivos (TestCase, CreatesApplication)
- **Cobertura**: No medida (objetivo: >70%)
- **Mantenibilidad**: 7/10

### Vulnerabilidades CrÃ­ticas Identificadas (Backend)

**CRÃTICO - Remediar Inmediatamente:**
1. âŒ **Rutas de debug expuestas** - `routes/api.php:19-27`
   - `/env-test` - Expone configuraciÃ³n con `dd(env('APP_NAME'), env('DB_DATABASE'), env('APP_DEBUG'))`
   - `/migrate-refresh` - Permite resetear BD en producciÃ³n con `Artisan::call('migrate:refresh', ['--seed' => true])`
   - **Impacto**: Seguridad - expone configuraciÃ³n y permite resetear BD
   - **Esfuerzo**: 5 minutos (eliminar o proteger con middleware `env('APP_ENV') === 'local'`)

2. âŒ **CI/CD configurando APP_DEBUG=true en producciÃ³n** - `.github/workflows/main.yml:58-59`
   - El pipeline de GitHub Actions fuerza `APP_DEBUG=true` en despliegue a producciÃ³n
   - LÃ­nea 58-59: `echo "APP_DEBUG=true" >> .env` y `sed -i 's/APP_DEBUG=.*/APP_DEBUG=true/' .env`
   - **Impacto**: Seguridad CRÃTICA - expone informaciÃ³n sensible en errores de producciÃ³n
   - **Esfuerzo**: 5 minutos (cambiar a `APP_DEBUG=false` o usar variable de entorno condicional)

### Deuda TÃ©cnica Identificada (Backend)

**Problemas conocidos a evitar:**

1. **CÃ³digo comentado extenso** (~160+ lÃ­neas identificadas):
   - `GasTicket.php:76-109` - 34 lÃ­neas comentadas
   - `SalesAdminController.php:30-39, 116-133` - 28 lÃ­neas comentadas
   - `EmailController.php:26-51` - 26 lÃ­neas comentadas (mÃ©todo store() completo)
   - `Station.php:32-49` - 18 lÃ­neas comentadas (relaciones y mÃ©todos)
   - `PhoneController.php:20-21, 29, 65-79` - 17 lÃ­neas comentadas
   - `DocumentController.php:68-85, 71, 101` - 18+ lÃ­neas comentadas
   - `GasTicketController.php:32, 62-72` - 11 lÃ­neas comentadas
   - `AddressController.php:33` - 1 lÃ­nea comentada
   - **Impacto**: Mantenibilidad - cÃ³digo muerto confunde
   - **Esfuerzo**: 45 minutos (limpiar todos)

2. **Logs de debug en producciÃ³n**:
   - `ProfileController.php:119, 152` - `Log::info('Fecha recibida: ...')`, `Log::info('No hay imagen anterior...')`
   - `PhoneController.php:83` - `Log::info('Datos recibidos:', $request->all())`
   - **Impacto**: Performance y seguridad - expone datos en logs
   - **Esfuerzo**: 15 minutos (remover o usar logger con niveles)

3. **Magic Numbers hardcodeados**:
   - `GasTicketController.php:152` - `$maxDailyAppointments = 200;` (lÃ­mite diario)
   - `GasTicketController.php:88-89` - `if ($daysSinceLastAppointment < 21)` (regla de 21 dÃ­as)
   - **Impacto**: Mantenibilidad - valores difÃ­ciles de cambiar
   - **Esfuerzo**: 30 minutos (extraer a `config/gas_ticket.php`)

4. **Queries duplicadas y N+1 potenciales**:
   - `GasTicketController::store()` - 2 queries similares (lÃ­neas 153-155 y 163-165)
     ```php
     // LÃ­nea 153: Query 1
     $dailyAppointments = GasTicket::whereDate('appointment_date', $appointmentDate)
         ->where('station_id', $stationId)->count();
     // LÃ­nea 163: Query 2 (similar) - reutilizar $dailyAppointments
     $queuePosition = GasTicket::whereDate('appointment_date', $appointmentDate)
         ->where('station_id', $stationId)->count() + 1;
     ```
   - BÃºsqueda de profile por user_id duplicada (5+ ubicaciones):
     - `GasTicketController::store()` - lÃ­nea 38
     - `GasTicketController::show()` - lÃ­nea 218
     - `GasTicketController::getGasCylinders()` - lÃ­nea 249
     - `ProfileController::show()` - lÃ­nea 91
     - `PhoneController::show()` - lÃ­nea 85
     - `EmailController::show()` - lÃ­nea 97
   - `DataVerificationController` - N+1 queries potenciales en bucles:
     - `updateVerificationsDocuments()` - lÃ­nea 141: `->get()` en bucle con `foreach`
     - `updateVerificationsAddresses()` - lÃ­nea 175: Similar
     - `updateVerificationsGasCylinders()` - lÃ­nea 208: Similar
     - `updateVerificationsPhones()` - lÃ­nea 241: Similar
     - `updateVerificationsEmails()` - lÃ­nea 275: Similar
   - **Impacto**: Performance - queries innecesarias y N+1 queries
   - **Esfuerzo**: 1 hora (optimizar reutilizando resultados y agregar eager loading donde sea necesario)

5. **Falta paginaciÃ³n** (6+ endpoints):
   - `GasTicketController::index()` - `->get()` sin paginaciÃ³n (lÃ­nea 24)
   - `ProfileController::index()` - `->get()` sin paginaciÃ³n (lÃ­nea 20)
   - `DocumentController::index()` - `->get()` sin paginaciÃ³n
   - `AddressController::index()` - `->get()` sin paginaciÃ³n
   - **Impacto**: Performance - puede retornar miles de registros
   - **Esfuerzo**: 2-3 horas (implementar `->paginate(15)`)

6. **Inconsistencias en timezone**:
   - Mezcla de `Carbon::now()` y `Carbon::now()->timezone('America/Caracas')`
   - **Ubicaciones**: `GasTicketController.php:124, 148, 184-186`
   - **Impacto**: Funcionalidad - bugs potenciales de fecha
   - **Esfuerzo**: 1 hora (estandarizar a `Carbon::now()->timezone('America/Caracas')`)

7. **LÃ³gica de negocio en controladores**:
   - `GasTicketController::store()` - 200+ lÃ­neas con lÃ³gica compleja
   - MÃºltiples controladores con validaciÃ³n y lÃ³gica mezclada
   - **Impacto**: Testabilidad - difÃ­cil de testear en aislamiento
   - **Esfuerzo**: 1 semana (extraer a servicios como `GasTicketService`, `ValidationService`)

8. **Sin caching**:
   - No hay estrategias de caching implementadas
   - Queries repetidas sin cache (Ãºltimo ticket, conteo diario, etc.)
   - **Impacto**: Performance - queries repetidas innecesarias
   - **Esfuerzo**: 2-4 horas (implementar Redis/caching bÃ¡sico)

9. **Falta Ã­ndices en base de datos para performance**:
   - `gas_tickets.appointment_date` - Sin Ã­ndice (usado en validaciÃ³n 21 dÃ­as y lÃ­mite diario)
   - `gas_tickets.station_id + appointment_date` - Sin Ã­ndice compuesto (usado en lÃ­mite diario)
   - `gas_tickets.status` - Sin Ã­ndice (usado en filtros por estado)
   - `gas_tickets.profile_id` - Sin Ã­ndice adicional (solo foreign key)
   - `profiles.user_id` - Sin Ã­ndice Ãºnico (usado frecuentemente para bÃºsquedas)
   - Solo 2 Ã­ndices encontrados en `complaints_table` (ci, email) - otros no tienen Ã­ndices de performance
   - **Impacto**: Performance - queries lentas con datos grandes
   - **Esfuerzo**: 1-2 horas (agregar Ã­ndices en migraciÃ³n)

10. **Bulk updates en DataVerificationController**:
    - MÃ©todos `updateVerifications*` usan `foreach` con `->save()` individual
    - `updateVerificationsDocuments()` lÃ­nea 151-154: `foreach ($documents as $document) { $document->save(); }`
    - Similar en `updateVerificationsAddresses()`, `updateVerificationsGasCylinders()`, etc.
    - **Impacto**: Performance - mÃºltiples queries UPDATE donde podrÃ­a ser 1
    - **Esfuerzo**: 30 minutos (usar `->update()` o `Model::whereIn()->update()`)

### Ãreas de Seguridad a Revisar

**CrÃ­ticas:**
- âŒ Rutas de debug expuestas (CRÃTICO - remediar inmediatamente)

**Importantes:**
- âš ï¸ Headers de seguridad (verificar CSP, HSTS, X-Frame-Options) - 1 hora
- âš ï¸ Rate limiting (implementar en autenticaciÃ³n) - 2-4 horas
- âš ï¸ Logging de seguridad (mejorar auditorÃ­a de acciones crÃ­ticas)

### Recomendaciones para Cursor AI

**Al trabajar en este proyecto backend:**

**CRÃTICO (Prioridad inmediata):**
- âŒ **NUNCA** dejar rutas de debug expuestas en producciÃ³n - Siempre verificar `routes/api.php`
- âœ… Eliminar o proteger rutas de debug con middleware `env('APP_ENV') === 'local'`
- âŒ **NUNCA** configurar `APP_DEBUG=true` en CI/CD de producciÃ³n - Verificar `.github/workflows/main.yml:58-59`
- âœ… En producciÃ³n usar `APP_DEBUG=false` o condicional basado en `APP_ENV`

**Seguridad:**
- âœ… Siempre validar inputs con Form Requests
- âœ… Usar Laravel Sanctum para autenticaciÃ³n
- âœ… Implementar rate limiting en endpoints sensibles
- âœ… No exponer informaciÃ³n sensible en logs (`Log::info` con datos de usuario)

**CÃ³digo y Calidad:**
- âœ… Limpiar cÃ³digo comentado cuando se modifique un archivo
- âœ… Extraer magic numbers (200, 21) a archivos de configuraciÃ³n
- âœ… Evitar queries duplicadas - reutilizar resultados cuando sea posible
- âœ… Implementar paginaciÃ³n en todos los mÃ©todos `index()` - usar `->paginate(15)`
- âœ… Estandarizar timezone a `America/Caracas` - usar `Carbon::now()->timezone('America/Caracas')`

**Arquitectura:**
- âœ… Extraer lÃ³gica de negocio compleja a servicios (ej: `GasTicketService`, `ValidationService`)
- âœ… Implementar Form Requests para validaciÃ³n centralizada
- âœ… Usar eager loading para evitar N+1 queries (`->with(['relaciones'])`)

**Performance:**
- âœ… Implementar caching para queries frecuentes (Redis)
- âœ… Revisar y agregar Ã­ndices en migraciones para columnas de bÃºsqueda frecuente
  - Agregar Ã­ndice en `gas_tickets.appointment_date`
  - Agregar Ã­ndice compuesto en `gas_tickets.station_id + appointment_date`
  - Agregar Ã­ndice en `gas_tickets.status`
  - Agregar Ã­ndice Ãºnico en `profiles.user_id`
- âœ… Optimizar queries duplicadas reutilizando resultados
- âœ… Usar bulk updates en lugar de `foreach` con `->save()` individual
  - `DataVerificationController::updateVerifications*()` mÃ©todos

**Testing:**
- âœ… Aumentar cobertura de tests - objetivo >70%
- âœ… Agregar tests para endpoints faltantes (Phone, Email, Document, Address controllers)
